<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>SmartGarden — Gestion des Réservations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="img/favicon.ico" rel="icon">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/evenements.css" rel="stylesheet">
    <style>
        .table-modern th { background-color: #2ecc71 !important; color: white; }
        .btn-edit { background-color: #f39c12; border: none; color: white; }
        .btn-edit:hover { background-color: #e67e22; }
        .btn-danger-soft { background-color: #ff6b6b; border: none; color: white; }
        .btn-danger-soft:hover { background-color: #ff5252; }
        .badge-user { background-color: #3498db; }
        .badge-event { background-color: #9b59b6; }
    </style>
</head>
<body>

<div class="container-fluid position-relative bg-white d-flex p-0">
    <!-- Sidebar -->
    <div class="sidebar pe-4 pb-3">
        <nav class="navbar bg-light navbar-light">
            <a href="index.html" class="navbar-brand mx-4 mb-2 mt-2">
                <h3 style="font-size: 1.2rem;padding-left: 20px; color: #2ecc71;">
                    <img src="img/logo-64x64.png" alt="Logo" class="me-2" style="width: 32px; height: 32px;">SmartGarden
                </h3>
            </a>
            <div class="d-flex align-items-center ms-4 mb-4">
                <div class="position-relative">
                    <img class="rounded-circle" src="img/user.jpg" alt="" style="width: 40px; height: 40px;">
                    <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"></div>
                </div>
                <div class="ms-3">
                    <h6 class="mb-0">Jhon Doe</h6>
                    <span>Admin</span>
                </div>
            </div>
            <div class="navbar-nav w-100">
                <a href="index.html" class="nav-item nav-link"><i class="fa fa-file-alt me-2"></i>Publication</a>
                <a href="plantes.html" class="nav-item nav-link"><i class="fa fa-leaf me-2"></i>Plantes</a>
                <a href="evenements.html" class="nav-item nav-link"><i class="fa fa-calendar me-2"></i>Evenements</a>
                <a href="reservations.html" class="nav-item nav-link active"><i class="fa fa-ticket-alt me-2"></i>Réservations</a>
                <a href="utilisateur.html" class="nav-item nav-link"><i class="fa fa-user me-2"></i>Utilisateur</a>
                <a href="capteurs.html" class="nav-item nav-link"><i class="fa fa-microchip me-2"></i>Capteurs</a>
            </div>
        </nav>
    </div>

    <!-- Content -->
    <div class="content w-100">
        <!-- Navbar -->
        <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
            <a href="#" class="sidebar-toggler flex-shrink-0"><i class="fa fa-bars"></i></a>
            <form class="d-none d-md-flex ms-4"><input class="form-control border-0" type="search" placeholder="Search"></form>
            <div class="navbar-nav align-items-center ms-auto">
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"><i class="fa fa-bell me-lg-2"></i><span class="d-none d-lg-inline-flex">Notification</span></a>
                    <div class="dropdown-menu dropdown-menu-end bg-light border-0 rounded-0 rounded-bottom m-0">
                        <a href="#" class="dropdown-item text-center">See all notifications</a>
                    </div>
                </div>
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                        <img class="rounded-circle me-lg-2" src="img/user.jpg" alt="" style="width: 40px; height: 40px;">
                        <span class="d-none d-lg-inline-flex">John Doe</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end bg-light border-0 rounded-0 rounded-bottom m-0">
                        <a href="#" class="dropdown-item">Log Out</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Header -->
        <div class="container-fluid pt-4 px-4">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h4 class="mb-0">Gestion des Réservations</h4>
                    <small class="text-muted">Voir, modifier et supprimer les réservations</small>
                </div>
                <button id="refreshBtn" class="btn btn-outline-secondary">
                    <i class="fa fa-sync me-1"></i> Rafraîchir
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="container-fluid px-4 mb-5">
            <div class="row g-4">
                <div class="col-sm-6 col-xl-3">
                    <div class="stats-card bg-white text-center p-4 rounded-4 shadow-lg border-0">
                        <i class="fa fa-ticket-alt text-primary mb-3" style="font-size: 3.5rem;"></i>
                        <h3 id="statTotal" class="text-primary fw-bold">0</h3>
                        <p class="text-muted mb-0">Total réservations</p>
                    </div>
                </div>
                <div class="col-sm-6 col-xl-3">
                    <div class="stats-card bg-white text-center p-4 rounded-4 shadow-lg border-0">
                        <i class="fa fa-users text-success mb-3" style="font-size: 3.5rem;"></i>
                        <h3 id="statUsers" class="text-success fw-bold">0</h3>
                        <p class="text-muted mb-0">Utilisateurs uniques</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="container-fluid px-4">
            <div class="bg-white rounded-4 p-4 shadow-lg card-custom">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0 fw-bold text-dark">Liste des réservations</h5>
                    <small id="listMessage" class="text-muted fw-medium">Chargement...</small>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle table-modern">
                        <thead class="table-primary text-white">
                            <tr>
                                <th>#</th>
                                <th>Événement</th>
                                <th>Utilisateur</th>
                                <th>Date de réservation</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reservationsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modifier -->
<div class="modal fade" id="editReservationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form id="editReservationForm" class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">Modifier la réservation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_id_reservation">
                <div class="mb-3">
                    <label class="form-label fw-bold">Événement</label>
                    <input type="text" id="edit_event_title" class="form-control" disabled>
                    <small class="text-muted">ID événement: <span id="edit_id_event"></span></small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Utilisateur ID</label>
                    <input type="number" id="edit_idUtilisateur" class="form-control" required min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Date de réservation</label>
                    <input type="datetime-local" id="edit_date_reservation" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" class="btn btn-theme">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Bas Droite -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="appToast" class="toast align-items-center text-white border-0 shadow-lg" role="alert">
        <div class="d-flex">
            <div class="toast-body fw-bold" id="toastBody">Opération réussie !</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = '/view/Backend/public/index.php';

    // Toast intelligent
    function showToast(message, type = 'success') {
        const toastEl = document.getElementById('appToast');
        const toastBody = document.getElementById('toastBody');
        
        toastEl.classList.remove('bg-success', 'bg-danger');
        if (type === 'delete') {
            toastEl.classList.add('bg-danger');
            message = message || "Réservation supprimée !";
        } else {
            toastEl.classList.add('bg-success');
            message = message || "Opération réussie !";
        }
        
        toastBody.textContent = message;
        new bootstrap.Toast(toastEl).show();
    }

    // Charger les réservations
    async function loadReservations() {
        $('#listMessage').text('Chargement...');
        $('#reservationsBody').html('');
        
        try {
            const res = await fetch(`${API_URL}?action=getAllReservations`);
            const json = await res.json();

            if (json.status !== "success" || !json.data.length) {
                $('#listMessage').text('Aucune réservation trouvée');
                $('#statTotal').text('0');
                $('#statUsers').text('0');
                return;
            }

            const reservations = json.data;
            $('#statTotal').text(reservations.length);
            $('#statUsers').text([...new Set(reservations.map(r => r.idUtilisateur))].length);

            let html = '';
            reservations.forEach((r, i) => {
                const dateFormatted = new Date(r.date_reservation).toLocaleString('fr-FR');
                const eventTitle = r.event_title || 'Événement #' + r.id_event;
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>
                            <span class="badge badge-event">${eventTitle}</span>
                            <small class="d-block text-muted">ID: ${r.id_event}</small>
                        </td>
                        <td><span class="badge badge-user">User ${r.idUtilisateur}</span></td>
                        <td>${dateFormatted}</td>
                        <td class="text-center">
                            <button onclick="openEditModal(${r.id_reservation}, ${r.id_event}, '${eventTitle.replace(/'/g, "\\'")}', ${r.idUtilisateur}, '${r.date_reservation}')" 
                                    class="btn btn-edit btn-sm me-1" title="Modifier">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button onclick="deleteReservation(${r.id_reservation})" 
                                    class="btn btn-danger-soft btn-sm" title="Supprimer">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            $('#reservationsBody').html(html);
            $('#listMessage').text(`Total: ${reservations.length} réservation(s)`);

        } catch (err) {
            $('#listMessage').text('Erreur de chargement');
            console.error(err);
        }
    }

    // Ouvrir modal
    function openEditModal(id_reservation, id_event, event_title, idUtilisateur, date_reservation) {
        $('#edit_id_reservation').val(id_reservation);
        $('#edit_id_event').text(id_event);
        $('#edit_event_title').val(event_title);
        $('#edit_idUtilisateur').val(idUtilisateur);
        $('#edit_date_reservation').val(date_reservation.slice(0, 16));
        new bootstrap.Modal(document.getElementById('editReservationModal')).show();
    }

    // Modifier
    $('#editReservationForm').on('submit', async function(e) {
        e.preventDefault();
        const data = {
            id_reservation: $('#edit_id_reservation').val(),
            idUtilisateur: $('#edit_idUtilisateur').val(),
            date_reservation: $('#edit_date_reservation').val()
        };

        try {
            const res = await fetch(`${API_URL}?action=updateReservation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            showToast(json.status === "success" ? "Modifiée avec succès !" : "Erreur de modification");
            if (json.status === "success") {
                bootstrap.Modal.getInstance(document.getElementById('editReservationModal')).hide();
                loadReservations();
            }
        } catch (err) {
            showToast("Erreur réseau", "error");
        }
    });

    // Supprimer
    async function deleteReservation(id) {
        if (!confirm("Supprimer cette réservation ?")) return;
        try {
            const res = await fetch(`${API_URL}?action=deleteReservation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_reservation: id })
            });
            const json = await res.json();
            showToast(json.status === "success" ? "Réservation supprimée !" : "Erreur suppression", json.status === "success" ? "delete" : "error");
            if (json.status === "success") loadReservations();
        } catch (err) {
            showToast("Erreur réseau", "error");
        }
    }

    // Init
    $(document).ready(function() {
        loadReservations();
        $('#refreshBtn').click(loadReservations);
    });
</script>
</body>
</html>