<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" type="image/png" href="./assets/images/logo-16x16.png" />
    <title>SmartGarden - Événements</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css?family=Major+Mono+Display" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.1/css/boxicons.min.css' rel='stylesheet'>

    <!-- Styles -->
    <link href="./assets/css/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/style.css" rel="stylesheet">
    <link href="./assets/css/components.css" rel="stylesheet">
    <link href="./assets/css/media.css" rel="stylesheet">

    <style>
        .category-section {
            margin: 3rem 0;
            padding-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }
        .category-section:last-child { border-bottom: none; }

        .category-title {
            font-size: 2rem;
            font-weight: 700;
            color: #27ae60;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 4px solid #27ae60;
            display: inline-block;
        }

        .event-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 12px;
            overflow: hidden;
        }
        .event-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.12) !important;
        }

        .card-title {
            font-size: 1.25rem;
            color: #2c3e50;
        }

        .badge-category {
            background-color: #3498db;
            color: white;
            font-size: 0.85rem;
        }
    </style>
</head>

<body class="newsfeed">
    <div class="container-fluid" id="wrapper">
        <div class="row newsfeed-size">
            <div class="col-md-12 newsfeed-right-side">
                <!-- NAVBAR (inchangée) -->
                <nav id="navbar-main" class="navbar navbar-expand-lg shadow-sm sticky-top">
                    <!-- [Ton NAVBAR complet ici - je le garde intact] -->
                    <div class="w-100 justify-content-md-center">
                        <ul class="nav navbar-nav enable-mobile px-2">
                            <li class="nav-item">
                                <button type="button" class="btn nav-link p-0"><img src="./assets/images/icons/theme/post-image.png" class="f-nav-icon" alt="Quick make post"></button>
                            </li>
                            <li class="nav-item w-100 py-2">
                                <form class="d-inline form-inline w-100 px-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control search-input" placeholder="Search for people, companies, events and more...">
                                        <div class="input-group-append">
                                            <button class="btn search-button" type="button"><i class='bx bx-search'></i></button>
                                        </div>
                                    </div>
                                </form>
                            </li>
                            <li class="nav-item">
                                <a href="messages.html" class="nav-link nav-icon nav-links message-drop drop-w-tooltip" data-placement="bottom" data-title="Messages">
                                    <img src="./assets/images/icons/navbar/message.png" class="message-dropdown f-nav-icon" alt="navbar icon">
                                </a>
                            </li>
                        </ul>
                        <ul class="navbar-nav mr-5 flex-row" id="main_menu">
                            <a class="navbar-brand nav-item mr-lg-5" href="index.html"><img src="./assets/images/logo-128x128.png" width="70" height="70" class="mr-3" alt="Logo"></a>
                            <form class="w-30 mx-2 my-auto d-inline form-inline mr-5">
                                <div class="input-group">
                                    <input type="text" class="form-control search-input w-75" placeholder="Search...">
                                    <div class="input-group-append">
                                        <button class="btn search-button" type="button"><i class='bx bx-search'></i></button>
                                    </div>
                                </div>
                            </form>
                            <button type="button" class="btn nav-link" id="menu-toggle"><img src="./assets/images/icons/theme/navs.png" alt="Menu"></button>
                        </ul>
                    </div>
                </nav>

                <div class="row newsfeed-right-side-content mt-3">
                    <!-- SIDEBAR -->
                    <div class="col-md-2 newsfeed-left-side sticky-top shadow-sm" id="sidebar-wrapper">
                        <div class="card newsfeed-user-card h-100">
                            <ul class="list-group list-group-flush newsfeed-left-sidebar">
                                <li class="list-group-item"><h6>Home</h6></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="profile.html" class="sidebar-item"><img src="./assets/images/icons/left-sidebar/newsfeed.png" alt="profile"> Profile</a>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="publications.html" class="sidebar-item"><img src="./assets/images/icons/left-sidebar/message.png" alt="publications"> Publications</a>
                                    <span class="badge badge-primary badge-pill"><i class='bx bx-chevron-right'></i></span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="plantes.html" class="sidebar-item"><img src="./assets/images/icons/left-sidebar/group.png" alt="plantes"> Plantes</a>
                                    <span class="badge badge-primary badge-pill"><i class='bx bx-chevron-right'></i></span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center sd-active">
                                    <a href="evenements.html" class="sidebar-item"><img src="./assets/images/icons/left-sidebar/event.png" alt="evenements"> Événements</a>
                                    <span class="badge badge-primary badge-pill"><i class='bx bx-chevron-right'></i></span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="capteurs.html" class="sidebar-item"><img src="./assets/images/icons/left-sidebar/saved.png" alt="capteurs"> Capteurs</a>
                                    <span class="badge badge-primary badge-pill"><i class='bx bx-chevron-right'></i></span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- CONTENU PRINCIPAL -->
                    <div class="col-md-10 second-section" id="page-content-wrapper">
                        <div class="jumbotron groups-banner text-white" style="background: linear-gradient(135deg, #27ae60, #2ecc71); border-radius: 15px;">
                            <div class="container group-banner-content">
                                <h1 class="jumbotron-heading mt-auto">
<img src="./assets/images/icons/theme/group-white.png" class="mr-3" alt="Bienvenue aux événements">                                    Événements
                                </h1>
                                <p class="lead">Tous les événements classés par catégorie</p>
                            </div>
                        </div>

                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h3 class="card-title text-success mb-4">
                                    <i class='bx bx-calendar-event'></i> Événements disponibles
                                </h3>

                                <div id="eventsContainer">
                                    <div id="eventsLoading" class="text-center py-5">
                                        <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"></div>
                                        <p class="mt-3">Chargement des événements...</p>
                                    </div>
                                    <div id="eventsEmpty" class="text-center py-5 text-muted" style="display:none;">
                                        <h4>Aucun événement pour le moment</h4>
                                        <p>Revenez plus tard !</p>
                                    </div>
                                    <div id="eventsByCategory"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./assets/js/jquery/jquery-3.3.1.min.js"></script>
    <script src="./assets/js/popper/popper.min.js"></script>
    <script src="./assets/js/bootstrap/bootstrap.min.js"></script>
    <script src="./assets/js/app.js"></script>
    <script src="./assets/js/components/components.js"></script>

<script type="text/javascript">
    const CURRENT_USER_ID = 999;

    // Récupère les événements déjà réservés par l'utilisateur 999
    async function getReservedEvents() {
        try {
            const response = await fetch('/view/Backend/public/index.php?action=getReservedByUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idUtilisateur: CURRENT_USER_ID })
            });

            if (!response.ok) return [];
            const data = await response.json();

            return data.status === "success" 
                ? data.data.map(item => parseInt(item))  // data.data est déjà un tableau d'id_event
                : [];
        } catch (e) {
            console.error("Erreur lors du chargement des réservations :", e);
            return [];
        }
    }

    // Échappement HTML pour sécurité
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    // Fonction de réservation (CORRIGÉE : envoi du bon champ + idUtilisateur)
    async function reserveEvent(eventId, button) {
        if (!confirm("Réserver cet événement ?")) return;

        // Désactiver le bouton immédiatement pour éviter le double clic
        button.disabled = true;
        button.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Réservation...';

        try {
            const response = await fetch('/view/Backend/public/index.php?action=reserve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_event: eventId,           // ← Nom EXACT attendu par le PHP
                    idUtilisateur: CURRENT_USER_ID  // ← On envoie aussi l'user (même si fallback à 999 côté serveur)
                })
            });

            const result = await response.json();

            if (result.status === "success") {
                alert("Réservé avec succès !");
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
                button.innerHTML = "<i class='bx bx-check-double'></i> Déjà réservé";
            } else {
                alert(result.message || "Erreur lors de la réservation");
                button.disabled = false;
                button.innerHTML = "<i class='bx bx-check-circle'></i> Réserver ma place";
            }
        } catch (err) {
            console.error("Erreur réseau :", err);
            alert("Erreur de connexion. Réessayez plus tard.");
            button.disabled = false;
            button.innerHTML = "<i class='bx bx-check-circle'></i> Réserver ma place";
        }
    }

    // Chargement des événements avec affichage par catégorie
    async function loadEventsByCategory() {
        const container = document.getElementById('eventsByCategory');
        const loading = document.getElementById('eventsLoading');
        const empty = document.getElementById('eventsEmpty');

        try {
            const response = await fetch('/view/Backend/public/index.php?action=list');
            if (!response.ok) throw new Error("Erreur serveur");

            const json = await response.json();
            const events = json.data || [];

            const reservedEventIds = await getReservedEvents();

            if (events.length === 0) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            // Grouper par catégorie
            const grouped = {};
            events.forEach(e => {
                const cat = e.nom_categorie || "Autres";
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(e);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(category => {
                const list = grouped[category];
                html += `
                    <div class="category-section">
                        <h2 class="category-title">
                            <i class='bx bxs-category'></i> ${escapeHtml(category)}
                            <small class="text-muted ml-3">(${list.length} événement${list.length > 1 ? 's' : ''})</small>
                        </h2>
                        <div class="row">
                            ${list.map(e => {
                                const id = parseInt(e.id_event);
                                const isReserved = reservedEventIds.includes(id);
                                return `
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card h-100 event-card shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">${escapeHtml(e.type_event || 'Événement')}</h5>
                                                <p class="text-muted small mb-2">
                                                    <i class='bx bx-calendar'></i> ${escapeHtml(e.date_event || 'Date non définie')}
                                                </p>
                                                <p class="card-text text-dark">${escapeHtml(e.description || 'Aucune description')}</p>
                                                <span class="badge badge-category">${escapeHtml(category)}</span>
                                            </div>
                                            <div class="card-footer bg-white border-0 text-center pt-3">
                                                <button 
                                                    ${isReserved ? 'disabled' : `onclick="reserveEvent(${id}, this)"`}
                                                    class="btn ${isReserved ? 'btn-secondary' : 'btn-success'} btn-block">
                                                    <i class='bx ${isReserved ? 'bx-check-double' : 'bx-check-circle'}'></i>
                                                    ${isReserved ? 'Déjà réservé' : 'Réserver ma place'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            loading.style.display = 'none';

        } catch (err) {
            console.error("Erreur chargement événements :", err);
            loading.innerHTML = '<p class="text-danger text-center">Impossible de charger les événements.</p>';
        }
    }

    // Lancement au chargement de la page
    window.addEventListener('load', loadEventsByCategory);

    // Menu mobile (inchangé)
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
</script>
</body>
</html>