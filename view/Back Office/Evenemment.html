<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion des Événements</title>
<style>
body { font-family: Arial; margin:30px; background:#f7f7f7; }
h2 { color:#333; }
form, table { background:white; padding:20px; border-radius:10px; margin-bottom:30px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
input, select { padding:8px; width:300px; margin-bottom:10px; }
button { padding:8px 16px; border:none; cursor:pointer; border-radius:5px; color:white; }
button:hover { opacity:0.8; }
table { width:100%; border-collapse:collapse; }
th, td { padding:12px; border-bottom:1px solid #ddd; text-align:left; }
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Event Management - Back Office</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root{ --accent1:#0b5ed7; --accent2:#20c997; --bg:#f4f7fb; --card:#ffffff }
        body { background:var(--bg); font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding:28px }
        .hero h1{ font-weight:700; letter-spacing: -0.5px }
        .card-custom{ border-radius:12px; box-shadow:0 8px 24px rgba(16,24,40,0.06); }
        .btn-theme-filled { color: #fff; background: linear-gradient(90deg,var(--accent1),var(--accent2)); border: none; box-shadow: 0 6px 18px rgba(32,201,151,0.08); }
        .table thead th{ background: linear-gradient(90deg, rgba(11,94,215,0.06), rgba(32,201,151,0.03)); color: rgba(7,55,99,0.9); }
        .toast-fixed{ position:fixed; right:24px; bottom:24px; z-index:1200; min-width:300px }
        .fade-slide{ transition: all .28s cubic-bezier(.2,.8,.2,1); opacity:0; transform:translateY(8px); }
        .fade-slide.show{ opacity:1; transform:translateY(0);} 
        .badge-success{ background: linear-gradient(90deg,var(--accent2), #28c47a); color:#fff }
        .badge-secondary{ background: rgba(11,94,215,0.06); color:var(--accent1); }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">Event Management (Back Office)</h1>

        <div class="card mb-4 card-custom">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <h5 class="mb-0">Add New Event</h5>
                        <small class="text-muted">Create events for your users</small>
                    </div>
                </div>
                <form id="addEventForm">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="eventType">Event Type</label>
                            <div class="input-group">
                                <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-tag"></i></span></div>
                                <input id="eventType" class="form-control" placeholder="Enter event type" required>
                            </div>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="eventDate">Date</label>
                            <div class="input-group">
                                <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-calendar-day"></i></span></div>
                                <input id="eventDate" type="date" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="eventStatus">Status</label>
                            <select id="eventStatus" class="form-control">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group col-md-1 d-grid">
                            <button class="btn btn-theme-filled btn-block" id="btnAdd"><i class="fa fa-plus mr-1"></i> Add</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm card-custom">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <h5 class="mb-0">List of Events</h5>
                        <small id="listMessage" class="text-muted">Loading events...</small>
                    </div>
                    <div>
                        <button id="refreshBtn" class="btn btn-sm btn-outline-primary"><i class="fa fa-sync"></i> Refresh</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="eventsTable">
                        <thead class="thead-light">
                            <tr>
                                <th style="width:8%">#</th>
                                <th>Type</th>
                                <th style="width:18%">Date</th>
                                <th style="width:12%">Status</th>
                                <th style="width:20%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eventsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-fixed">
        <div id="successToast" class="alert alert-success fade-slide" role="alert" style="display:none"><i class="fa fa-check-circle mr-2"></i><span id="sText"></span></div>
        <div id="dangerToast" class="alert alert-danger fade-slide" role="alert" style="display:none"><i class="fa fa-exclamation-circle mr-2"></i><span id="dText"></span></div>
    </div>

    <script>
        // API base (Back Office router)
        const API = 'index.php';
        let eventsList = [];
        const listMsg = document.getElementById('listMessage');

        function setListMessage(msg, muted=true){ listMsg.innerText = msg; listMsg.style.color = muted ? '#6c757d' : '#dc3545'; }
        function escapeHtml(str){ return String(str||'').replace(/[&<>'\"]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','\"':'&quot;' }[s])); }
        function isDateInPast(dateStr){ if(!dateStr) return true; const d=new Date(dateStr); const t=new Date(); t.setHours(0,0,0,0); d.setHours(0,0,0,0); return d<t; }

        function showSuccess(msg){ const el=document.getElementById('successToast'); document.getElementById('sText').innerText = msg; el.classList.add('show'); el.style.display='block'; clearTimeout(window._sT); window._sT = setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.style.display='none',300); },3500); }
        function showDanger(msg){ const el=document.getElementById('dangerToast'); document.getElementById('dText').innerText = msg; el.classList.add('show'); el.style.display='block'; clearTimeout(window._dT); window._dT = setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.style.display='none',300); },4000); }

        async function loadEvents(){
            setListMessage('Loading...');
            try{
                const res = await fetch(API + '?action=getAll');
                const json = await res.json();
                if(json.status === 'success' && Array.isArray(json.data)){
                    eventsList = json.data.map(ev => ({ id: Number(ev.id_event), type: ev.type_event, date: ev.date_event, status: ev.etat }));
                    renderTable();
                } else {
                    setListMessage('No events yet.');
                    document.getElementById('eventsBody').innerHTML = `<tr><td colspan="5">No events available.</td></tr>`;
                }
            }catch(err){ console.error(err); setListMessage('Failed to load events', false); }
        }

        function renderTable(){
            const tbody = document.getElementById('eventsBody'); tbody.innerHTML = '';
            if(eventsList.length === 0){ setListMessage('No events yet.', true); return; }
            setListMessage('');
            eventsList.forEach((ev, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${idx+1}</td>
                    <td>${escapeHtml(ev.type)}</td>
                    <td>${ev.date || ''}</td>
                    <td>${ev.status === 'active' ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-secondary">Inactive</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary mr-2" onclick="startEdit(${ev.id})"><i class='fa fa-pen'></i> Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent(${ev.id})"><i class='fa fa-trash'></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('addEventForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const type = document.getElementById('eventType').value.trim();
            const date = document.getElementById('eventDate').value;
            const status = document.getElementById('eventStatus').value;
            if(!type){ showDanger('Please provide event type.'); return; }
            if(isDateInPast(date)){ showDanger("La date doit être aujourd'hui ou une date future."); return; }
            const payload = { type_event: type, date_event: date, etat: status };
            try{
                const res = await fetch(API + '?action=add', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const j = await res.json();
                if(j.status === 'success'){ showSuccess(j.message || 'Added'); this.reset(); await loadEvents(); }
                else showDanger(j.message || 'Add failed');
            }catch(err){ console.error(err); showDanger('Server error'); }
        });

        async function deleteEvent(id){
            if(!confirm('Supprimer cet événement ?')) return;
            try{
                const res = await fetch(API + '?action=delete&id=' + encodeURIComponent(id));
                const j = await res.json();
                if(j.status === 'success'){ showDanger(j.message || 'Deleted'); await loadEvents(); }
                else showDanger(j.message || 'Delete failed');
            }catch(err){ console.error(err); showDanger('Server error'); }
        }

        async function startEdit(id){
            try{
                const res = await fetch(API + '?action=getOne&id=' + encodeURIComponent(id));
                const j = await res.json();
                if(j.status === 'success' && j.data){
                    const ev = j.data;
                    // prefill add form for simplicity
                    document.getElementById('eventType').value = ev.type_event;
                    document.getElementById('eventDate').value = ev.date_event;
                    document.getElementById('eventStatus').value = ev.etat;
                    // change add button to indicate update
                    document.getElementById('btnAdd').innerHTML = '<i class="fa fa-save"></i> Update';
                    document.getElementById('btnAdd').dataset.editing = ev.id_event;
                    showSuccess('Edit mode: modify fields and click Update');
                } else showDanger(j.message || 'Cannot fetch event');
            }catch(err){ console.error(err); showDanger('Server error'); }
        }

        // handle update when add button has editing data
        document.getElementById('btnAdd').addEventListener('click', async function(e){
            const editing = this.dataset.editing;
            if(!editing) return; // not in edit mode
            e.preventDefault();
            const id = editing;
            const type = document.getElementById('eventType').value.trim();
            const date = document.getElementById('eventDate').value;
            const status = document.getElementById('eventStatus').value;
            if(!type){ showDanger('Please provide event type.'); return; }
            if(isDateInPast(date)){ showDanger("La date doit être aujourd'hui ou une date future."); return; }
            const payload = { type_event: type, date_event: date, etat: status };
            try{
                const res = await fetch(API + '?action=update&id=' + encodeURIComponent(id), { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const j = await res.json();
                if(j.status === 'success'){ showSuccess(j.message || 'Updated'); delete this.dataset.editing; this.innerHTML = '<i class="fa fa-plus mr-1"></i> Add'; document.getElementById('addEventForm').reset(); await loadEvents(); }
                else showDanger(j.message || 'Update failed');
            }catch(err){ console.error(err); showDanger('Server error'); }
        });

        document.getElementById('refreshBtn').addEventListener('click', loadEvents);

        // initial load
        loadEvents();
    </script>
</body>
</html>
}
</script>
</body>
</html>
